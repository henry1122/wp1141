# 修复登录流程说明

## ✅ 已完成的修复

1. **OAuth 登录按钮**：现在会在登录前清除现有 session
2. **Redirect 回调**：确保 OAuth 登录后跳转到注册页面
3. **清除 Guest Session API**：创建了 `/api/auth/clear-guest-session` 端点

## 🔧 需要您执行的操作

### 步骤 1: 清除浏览器 Cookies

1. 打开浏览器开发者工具（F12）
2. 前往 **Application** 标签（Chrome）或 **Storage** 标签（Firefox）
3. 在左侧找到 **Cookies** → `http://localhost:3000`
4. 删除所有 cookies，特别是：
   - `next-auth.session-token`
   - `next-auth.csrf-token`
   - 其他相关的 cookies

### 步骤 2: 清除 Guest 账号的 Session（可选）

访问以下 URL 来清除数据库中 guest 账号的 session：
```
http://localhost:3000/api/auth/clear-guest-session
```

或者使用命令行：
```bash
curl -X POST http://localhost:3000/api/auth/clear-guest-session
```

### 步骤 3: 重新登录

1. 访问 `http://localhost:3000`
2. 应该会自动跳转到登录页面
3. 点击 **"Continue with Google"** 或 **"Continue with GitHub"**
4. 完成 OAuth 授权后，应该会跳转到注册页面（`/auth/register`）
5. 输入 userID（3-20 字符，字母数字下划线）
6. 点击注册
7. 注册成功后，会跳转到首页

## 📋 正确的登录流程

### OAuth 登录流程：
1. 用户点击 OAuth 按钮（Google/GitHub）
2. 系统清除现有 session
3. 跳转到 OAuth 提供商登录页面
4. 用户授权后，回调到 `/api/auth/callback/[provider]`
5. NextAuth 创建用户账户（如果不存在）
6. **重定向到 `/auth/register`**（如果用户没有 userID）
7. 用户在注册页面输入 userID
8. 注册成功后，跳转到首页

### UserID 登录流程：
1. 用户点击 "Login with UserID"
2. 输入已注册的 userID
3. 系统查找用户
4. **对于 OAuth 用户**：触发对应 provider 的 OAuth 登录
5. **对于 credentials 用户**：直接创建 session 并登录

## ⚠️ 重要提示

- **不要使用 guest 账号**：guest 账号只是测试用的，不应该在正常流程中使用
- **首次 OAuth 登录必须注册 userID**：系统会强制跳转到注册页面
- **Session 管理**：登录后 session 有效期为 30 天，未过期时可以直接访问

## 🔍 验证修复

登录后检查：
1. ✅ OAuth 登录后跳转到注册页面（如果用户没有 userID）
2. ✅ 注册页面显示正确的用户信息（从 OAuth 获取）
3. ✅ 注册成功后跳转到首页
4. ✅ 首页显示正确的用户信息（包括 userID）
5. ✅ 不再自动进入 guest 账号

## 🐛 如果问题仍然存在

1. **清除所有 cookies 和缓存**
2. **访问清除 API**：`http://localhost:3000/api/auth/clear-guest-session`
3. **检查浏览器控制台**：查看是否有错误信息
4. **检查服务器日志**：查看 NextAuth 的 redirect 和 session 回调日志

