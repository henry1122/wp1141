# 登录流程说明

## 🔐 注册与登录流程

### 1. OAuth 登录（Google/GitHub）

**流程：**
1. 用户点击 "Continue with Google" 或 "Continue with GitHub"
2. 跳转到 OAuth 提供商的登录页面
3. 用户授权后，回调到 `/api/auth/callback/[provider]`
4. NextAuth 创建用户账户（如果不存在）
5. **重要：** 如果用户没有 userID，系统会重定向到 `/auth/register`
6. 用户在注册页面输入 userID（3-20 字符，仅字母数字和下划线）
7. 注册成功后，用户被重定向到首页

**特点：**
- 同一个人使用不同的 OAuth providers 会创建不同的账户
- 每个 OAuth provider 的账户需要单独注册 userID
- 例如：Google 登录注册 `user123`，GitHub 登录可以注册 `user456`

### 2. UserID 登录

**流程：**
1. 用户在登录页面点击 "Login with UserID"
2. 输入已注册的 userID
3. 系统查找该 userID 对应的用户
4. **对于 OAuth 用户：**
   - 系统会识别用户使用的 OAuth provider（Google 或 GitHub）
   - 自动触发对应 provider 的 OAuth 登录流程
   - 用户完成 OAuth 授权后，自动登录
5. **对于 credentials 用户（如 guest）：**
   - 系统会创建 NextAuth session
   - 直接登录成功

**特点：**
- OAuth 用户使用 userID 登录时，仍然需要通过 OAuth 授权
- 这确保了安全性，因为 OAuth 是主要的认证方式
- userID 只是用来识别用户，实际的认证仍然通过 OAuth

### 3. Session 管理

**Session 配置：**
- 策略：数据库 session（`strategy: 'database'`）
- 有效期：30 天（`maxAge: 30 * 24 * 60 * 60`）
- 存储：MongoDB 的 `sessions` 表

**Session 行为：**
- 登录后创建 session
- 如果 session 未过期，用户可以直接访问（自动登录）
- Session 过期后，用户需要重新登录

## ⚠️ 重要说明

### Guest 账号

系统中可能存在 `guest` 账号（通过 `/api/admin/create-guest` 创建），但：
- **这不是自动登录的账号**
- 用户必须手动使用 `guest` 作为 userID 登录
- 如果不想使用 guest 账号，可以忽略它

### 确保正确的登录流程

1. **首次使用 OAuth 登录：**
   - 必须注册 userID
   - 不能跳过注册步骤

2. **使用 userID 登录：**
   - OAuth 用户：会触发 OAuth 授权流程
   - Credentials 用户：直接创建 session

3. **Session 未过期：**
   - 用户可以直接访问，无需重新登录

## 🔧 故障排除

### 问题：登录后直接进入 guest 账号

**可能原因：**
1. 浏览器中有 guest 账号的 session cookie
2. 数据库中 guest 账号有有效的 session

**解决方法：**
1. 清除浏览器 cookies
2. 在数据库中删除 guest 账号的 session
3. 重新登录

### 问题：OAuth 登录后没有跳转到注册页面

**检查：**
1. 确认 `lib/auth.ts` 中的 `redirect` callback 正确配置
2. 确认用户确实没有 userID（检查数据库）
3. 查看浏览器控制台和服务器日志

### 问题：UserID 登录失败

**检查：**
1. 确认 userID 已注册（检查数据库）
2. 确认用户有对应的 OAuth account（对于 OAuth 用户）
3. 查看 API 响应和错误信息

